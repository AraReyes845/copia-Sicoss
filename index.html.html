<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SICOSS Enterprise 2026 | Excel Import</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Librerías para manejo de Excel y CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .row-animate { animation: slideIn 0.3s ease-out forwards; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen">

    <!-- App Wrapper -->
    <div class="max-w-7xl mx-auto px-4 py-8 md:py-12">
        
        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-6 mb-12">
            <div class="flex items-center gap-4">
                <div class="bg-indigo-600 p-4 rounded-3xl text-white shadow-2xl shadow-indigo-200">
                    <i data-lucide="shield-check" size="32"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black tracking-tighter text-slate-900 leading-none uppercase">SICOSS <span class="text-indigo-600">Core 2026</span></h1>
                    <p class="text-slate-500 text-[11px] font-bold uppercase tracking-[0.3em] mt-2">Compatible con Excel & CONTAPAQi</p>
                </div>
            </div>
            
            <div class="flex flex-wrap items-center gap-3">
                <div class="bg-white px-6 py-3 rounded-2xl border border-slate-200 shadow-sm text-center">
                    <p class="text-[10px] font-bold text-slate-400 uppercase mb-1">UMA 2026</p>
                    <p class="text-lg font-black text-slate-700 leading-none">$117.30</p>
                </div>
                <div class="bg-indigo-600 px-6 py-3 rounded-2xl shadow-lg shadow-indigo-100 text-center">
                    <p class="text-[10px] font-bold text-indigo-200 uppercase mb-1">Plantilla</p>
                    <p id="total-employees" class="text-lg font-black text-white leading-none">0</p>
                </div>
            </div>
        </header>

        <!-- Kpis Dashboard -->
        <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            <div class="bg-slate-900 rounded-[2.5rem] p-8 text-white shadow-2xl relative overflow-hidden">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Costo Total Empresa</p>
                <h2 id="kpi-costo-total" class="text-3xl font-black tracking-tighter">$0.00</h2>
                <div class="mt-4 flex items-center gap-2 text-indigo-400 text-[10px] font-bold uppercase tracking-widest">
                    <i data-lucide="briefcase" size="14"></i> Nómina Bruta + Carga Social
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 border border-slate-200 shadow-sm">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Sueldos Netos</p>
                <h2 id="kpi-neto" class="text-3xl font-black text-slate-800 tracking-tighter">$0.00</h2>
                <div class="mt-4 h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                    <div id="neto-progress" class="h-full bg-emerald-500 transition-all duration-1000" style="width: 0%"></div>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 border border-slate-200 shadow-sm">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Pasivo Fiscal (ISR/IMSS)</p>
                <h2 id="kpi-retenciones" class="text-3xl font-black text-rose-500 tracking-tighter">$0.00</h2>
                <p class="text-slate-400 text-[10px] mt-4 font-bold uppercase tracking-tighter">Retención a Trabajadores</p>
            </div>

            <div class="bg-white rounded-[2.5rem] p-8 border border-slate-200 shadow-sm">
                <p class="text-slate-400 text-xs font-bold uppercase mb-2">Aportación Patronal</p>
                <h2 id="kpi-patronal" class="text-3xl font-black text-indigo-600 tracking-tighter">$0.00</h2>
                <p class="text-slate-400 text-[10px] mt-4 font-bold uppercase tracking-tighter">Incluye Infonavit & RCV</p>
            </div>
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Sidebar: Import Tools -->
            <aside class="lg:col-span-4 space-y-6">
                <div class="bg-white rounded-[2.5rem] border border-slate-200 shadow-sm p-8">
                    <h3 class="text-xl font-black mb-6 flex items-center gap-3">
                        <i data-lucide="file-up" class="text-indigo-600"></i>
                        Importar Datos
                    </h3>
                    
                    <div class="space-y-4">
                        <label class="block group cursor-pointer">
                            <div class="flex flex-col items-center justify-center border-2 border-dashed border-slate-200 rounded-3xl p-8 transition-all hover:border-indigo-400 hover:bg-indigo-50/50">
                                <i data-lucide="file-spreadsheet" size="40" class="text-slate-300 group-hover:text-indigo-500 mb-4 transition-colors"></i>
                                <span class="text-xs font-bold text-slate-400 group-hover:text-indigo-600 uppercase tracking-widest text-center">Selecciona tu archivo .XLSX o .CSV</span>
                                <input type="file" id="file-input" accept=".xlsx, .xls, .csv" class="hidden">
                            </div>
                        </label>

                        <div class="relative py-4 flex items-center justify-center">
                            <div class="absolute inset-0 flex items-center"><span class="w-full border-t border-slate-100"></span></div>
                            <span class="relative bg-white px-3 text-[10px] font-bold text-slate-300 uppercase tracking-[0.3em]">O manual</span>
                        </div>

                        <button onclick="openManualModal()" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-600 font-black py-4 rounded-2xl transition-all flex items-center justify-center gap-2 uppercase tracking-widest text-[10px]">
                            <i data-lucide="user-plus" size="14"></i> Agregar Empleado
                        </button>
                    </div>
                </div>

                <div class="bg-amber-50 border border-amber-100 rounded-[2.5rem] p-8">
                    <h4 class="text-xs font-black uppercase text-amber-900 mb-3 flex items-center gap-2">
                        <i data-lucide="alert-circle" size="14"></i> Nota de Seguridad
                    </h4>
                    <p class="text-[11px] text-amber-800 leading-relaxed font-medium">
                        Esta herramienta procesa los datos <strong>localmente en tu navegador</strong>. Ninguna información de sueldos o nombres se envía a internet. Es 100% privado.
                    </p>
                </div>
            </aside>

            <!-- Main: Results Table -->
            <main class="lg:col-span-8">
                <div class="bg-white rounded-[3rem] border border-slate-200 shadow-sm overflow-hidden flex flex-col min-h-[650px]">
                    <div class="p-8 border-b border-slate-100 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
                        <h3 class="font-black text-slate-800 uppercase tracking-widest text-sm flex items-center gap-3">
                            <i data-lucide="table" class="text-indigo-600"></i> Detalle de Nómina 2026
                        </h3>
                        <div class="flex items-center gap-2">
                            <button onclick="exportToExcel()" class="bg-emerald-50 text-emerald-700 hover:bg-emerald-100 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest flex items-center gap-2 transition-colors">
                                <i data-lucide="download" size="14"></i> Exportar
                            </button>
                            <button onclick="clearAll()" class="bg-rose-50 text-rose-600 hover:bg-rose-100 px-4 py-2 rounded-xl text-[10px] font-black uppercase tracking-widest transition-colors">
                                Limpiar
                            </button>
                        </div>
                    </div>

                    <div class="overflow-x-auto flex-grow custom-scrollbar">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-400 text-[10px] font-black uppercase tracking-widest border-b border-slate-100 sticky top-0 z-10">
                                <tr>
                                    <th class="px-8 py-5">Colaborador / Puesto</th>
                                    <th class="px-6 py-5">Bruto</th>
                                    <th class="px-6 py-5 text-indigo-600">Neto</th>
                                    <th class="px-6 py-5 text-rose-500">ISR/IMSS Obrero</th>
                                    <th class="px-6 py-5">Carga Patronal</th>
                                    <th class="px-8 py-5"></th>
                                </tr>
                            </thead>
                            <tbody id="payroll-body" class="divide-y divide-slate-100">
                                <!-- Filas dinámicas -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Footer Summary -->
                    <div id="table-footer" class="p-8 bg-slate-900 border-t border-slate-800 hidden">
                        <div class="flex flex-col sm:flex-row justify-between items-center text-white gap-4 text-center sm:text-left">
                            <div>
                                <p class="text-[10px] font-black text-slate-500 uppercase tracking-[0.3em] mb-1">Costo Total Mensual (Patrón)</p>
                                <p id="footer-total-cost" class="text-3xl font-black text-indigo-400">$0.00</p>
                            </div>
                            <div class="sm:text-right">
                                <p class="text-[9px] font-black text-slate-500 uppercase tracking-widest mb-1">Neto Total a Pagar</p>
                                <p id="footer-total-net" class="text-2xl font-black">$0.00</p>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modal: Agregar Manual -->
    <div id="manual-modal" class="fixed inset-0 z-50 flex items-center justify-center p-6 bg-slate-900/80 backdrop-blur-sm hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-[3.5rem] shadow-2xl w-full max-w-lg overflow-hidden border border-slate-100 transform scale-95 transition-all duration-300">
            <div class="p-10 border-b border-slate-100 flex justify-between items-center bg-indigo-50/30">
                <div class="flex items-center gap-4">
                    <div class="bg-indigo-600 p-3 rounded-2xl text-white shadow-lg shadow-indigo-100">
                        <i data-lucide="user-plus" size="24"></i>
                    </div>
                    <div>
                        <h3 class="text-2xl font-black text-slate-800 tracking-tighter">Nuevo Registro</h3>
                    </div>
                </div>
                <button onclick="closeManualModal()" class="p-2 hover:bg-white rounded-full transition-all text-slate-400 border border-slate-100">
                    <i data-lucide="x" size="20"></i>
                </button>
            </div>
            <div class="p-10 space-y-5">
                <input type="text" id="m-nombre" placeholder="Nombre completo" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500 font-semibold">
                <input type="text" id="m-puesto" placeholder="Puesto / Área" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500 font-semibold">
                <div class="grid grid-cols-2 gap-4">
                    <input type="number" id="m-sueldo" placeholder="Sueldo Bruto" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-5 py-4 outline-none focus:ring-2 focus:ring-indigo-500 font-black">
                    <select id="m-zona" class="w-full bg-slate-50 border border-slate-200 rounded-2xl px-4 py-4 font-bold appearance-none">
                        <option value="general">Zona General</option>
                        <option value="frontera">Zona Norte</option>
                    </select>
                </div>
                <button onclick="addManual()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-black py-5 rounded-2xl shadow-xl transition-all uppercase tracking-widest text-xs">
                    Confirmar Alta
                </button>
            </div>
        </div>
    </div>

    <!-- Script: Logic 2026 -->
    <script>
        // Configuración Fiscal 2026
        const CONFIG = {
            UMA: 117.30,
            DIAS_MES: 30.4,
            TABLA_ISR: [
                { inf: 0.01, fija: 0.0, pct: 0.0192 },
                { inf: 844.59, fija: 16.22, pct: 0.0640 },
                { inf: 7168.45, fija: 420.94, pct: 0.1088 },
                { inf: 12598.63, fija: 1012.01, pct: 0.1600 },
                { inf: 14645.72, fija: 1339.54, pct: 0.1792 },
                { inf: 17533.65, fija: 1856.84, pct: 0.2136 },
                { inf: 35352.02, fija: 5662.63, pct: 0.2352 },
                { inf: 55726.04, fija: 10454.49, pct: 0.3000 },
                { inf: 106363.02, fija: 25645.58, pct: 0.3200 },
                { inf: 141817.36, fija: 36990.97, pct: 0.3400 },
                { inf: 425452.10, fija: 133426.78, pct: 0.3500 }
            ]
        };

        let empleados = [];

        // Lógica de Cálculo
        function getRCVPct(sbc, uma) {
            const prop = sbc / uma;
            if (prop <= 1.0) return 0.03150;
            if (prop <= 1.5) return 0.03681;
            if (prop <= 2.0) return 0.04851;
            if (prop <= 2.5) return 0.05556;
            if (prop <= 3.0) return 0.06030;
            if (prop <= 3.5) return 0.06360;
            if (prop <= 4.0) return 0.06610;
            return 0.07513; 
        }

        function calculate(emp) {
            const bruto = emp.salarioBruto;
            const sdi = bruto / CONFIG.DIAS_MES;
            const factor = 1.0493; // Mínimo Ley 2026 (Vacaciones Dignas)
            const sbc = Math.min(sdi * factor, CONFIG.UMA * 25);

            // ISR
            let isr = 0;
            const bracket = [...CONFIG.TABLA_ISR].reverse().find(b => bruto >= b.inf);
            if (bracket) isr = bracket.fija + (bruto - bracket.inf) * bracket.pct;

            // IMSS Obrero
            const imssObr = ((Math.max(0, sbc - (3 * CONFIG.UMA)) * 0.004) + (sbc * 0.0025) + (sbc * 0.00625) + (sbc * 0.01125)) * CONFIG.DIAS_MES;

            // Carga Patronal (RCV 2026)
            const rcvPct = getRCVPct(sbc, CONFIG.UMA);
            const imssPat = ((CONFIG.UMA * 0.204) + (Math.max(0, sbc - (3 * CONFIG.UMA)) * 0.011) + (sbc * 0.06325) + (sbc * rcvPct)) * CONFIG.DIAS_MES;
            const infonavit = sbc * 0.05 * CONFIG.DIAS_MES;

            return {
                ...emp,
                sbc,
                isr,
                imssObr,
                neto: bruto - isr - imssObr,
                patronal: imssPat + infonavit,
                costoTotal: bruto + imssPat + infonavit
            };
        }

        // Interfaz y Render
        const format = (v) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(v);

        function updateUI() {
            const body = document.getElementById('payroll-body');
            body.innerHTML = '';
            let t = { neto: 0, ret: 0, pat: 0, cost: 0 };

            empleados.forEach((e, idx) => {
                const c = calculate(e);
                t.neto += c.neto;
                t.ret += (c.isr + c.imssObr);
                t.pat += c.patronal;
                t.cost += c.costoTotal;

                const row = document.createElement('tr');
                row.className = "hover:bg-indigo-50/30 transition-colors row-animate";
                row.innerHTML = `
                    <td class="px-8 py-6">
                        <div class="font-bold text-slate-800">${c.nombre}</div>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-[9px] font-black bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded uppercase tracking-wider">${c.puesto}</span>
                            <span class="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">${c.zona}</span>
                        </div>
                    </td>
                    <td class="px-6 py-6 font-semibold text-slate-400">${format(c.salarioBruto)}</td>
                    <td class="px-6 py-6">
                        <div class="font-black text-indigo-600 text-base">${format(c.neto)}</div>
                        <div class="text-[9px] text-slate-400 font-bold">SBC: ${format(c.sbc)}</div>
                    </td>
                    <td class="px-6 py-6">
                        <div class="text-rose-500 font-bold">${format(c.isr + c.imssObr)}</div>
                        <div class="text-[9px] text-slate-300">Retención de Ley</div>
                    </td>
                    <td class="px-6 py-6 font-bold text-slate-700">${format(c.patronal)}</td>
                    <td class="px-8 py-6 text-right">
                        <button onclick="removeEmp(${idx})" class="p-2 text-slate-200 hover:text-rose-500 transition-colors">
                            <i data-lucide="trash-2" size="16"></i>
                        </button>
                    </td>
                `;
                body.appendChild(row);
            });

            // Actualizar KPIs
            document.getElementById('kpi-costo-total').innerText = format(t.cost);
            document.getElementById('kpi-neto').innerText = format(t.neto);
            document.getElementById('kpi-retenciones').innerText = format(t.ret);
            document.getElementById('kpi-patronal').innerText = format(t.pat);
            document.getElementById('total-employees').innerText = empleados.length;
            
            document.getElementById('footer-total-cost').innerText = format(t.cost);
            document.getElementById('footer-total-net').innerText = format(t.neto);
            document.getElementById('neto-progress').style.width = t.cost > 0 ? `${(t.neto / t.cost) * 100}%` : '0%';
            
            document.getElementById('table-footer').classList.toggle('hidden', empleados.length === 0);
            lucide.createIcons();
        }

        // Manejo de Archivos (Excel & CSV)
        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

            if (isExcel) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    processData(jsonData);
                };
                reader.readAsArrayBuffer(file);
            } else {
                Papa.parse(file, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        processData(results.data);
                    }
                });
            }
        });

        function processData(data) {
            const nuevos = data.map(row => {
                // Mapeo inteligente de columnas CONTAPAQi
                const nombre = row.Nombre || row['Nombre de Empleado'] || row['NOMBRE'] || 'Sin Nombre';
                const puesto = row.Puesto || row['PUESTO'] || 'General';
                const bruto = parseFloat(row.Ingreso || row['Ingreso Bruto'] || row['INGRESO'] || 0);

                if (isNaN(bruto) || bruto === 0) return null;

                return {
                    nombre,
                    puesto,
                    salarioBruto: bruto,
                    zona: 'general'
                };
            }).filter(x => x);

            empleados = [...empleados, ...nuevos];
            updateUI();
        }

        // Manual
        function openManualModal() {
            const m = document.getElementById('manual-modal');
            m.classList.remove('hidden');
            setTimeout(() => { m.classList.remove('opacity-0'); m.children[0].classList.remove('scale-95'); }, 10);
        }

        function closeManualModal() {
            const m = document.getElementById('manual-modal');
            m.classList.add('opacity-0'); m.children[0].classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        function addManual() {
            const n = document.getElementById('m-nombre').value;
            const p = document.getElementById('m-puesto').value;
            const s = parseFloat(document.getElementById('m-sueldo').value);
            const z = document.getElementById('m-zona').value;

            if (!n || isNaN(s)) return;
            empleados.push({ nombre: n, puesto: p, salarioBruto: s, zona: z });
            closeManualModal();
            updateUI();
        }

        function removeEmp(idx) { empleados.splice(idx, 1); updateUI(); }
        function clearAll() { if(confirm("¿Limpiar toda la nómina?")) { empleados = []; updateUI(); } }

        function exportToExcel() {
            let csv = "data:text/csv;charset=utf-8,Colaborador,Puesto,Salario Bruto,SBC 2026,ISR,IMSS Obrero,Sueldo Neto,Carga Patronal,Costo Empresa\n";
            empleados.forEach(e => {
                const c = calculate(e);
                csv += `${c.nombre},${c.puesto},${c.salarioBruto},${c.sbc},${c.isr},${c.imssObr},${c.neto},${c.patronal},${c.costoTotal}\n`;
            });
            const encoded = encodeURI(csv);
            const link = document.createElement("a");
            link.setAttribute("href", encoded);
            link.setAttribute("download", "SICOSS_REPORT_2026.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = () => lucide.createIcons();
    </script>
</body>
</html>